<!DOCTYPE html>
<html lang="fa">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دنگ‌گیری دورهمی</title>
    <style>
        :root {
            direction: rtl;
        }

        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            direction: rtl;
            text-align: right;
        }

        header {
            background-color: #28a745;
            color: white;
            padding: 1rem;
            text-align: center;
            position: relative;
            /* Added padding-bottom to give space for sokhaneRooz */
            padding-bottom: 2.5rem;
        }

        header h1 {
            font-size: 1.8rem;
            margin: 0;
			padding-top: 10px;
        }

        #clock {
            color: white;
            position: absolute;
            top: 0.1rem;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            width: 90%;
            text-align: center; /* Ensure clock is centered */
        }

        /* New style for Sokhane Rooz */
        #sokhaneRooz {
            color: white;
            text-align: center;
            font-size: 0.9rem;
            margin-top: 1.5rem; /* Space between clock and proverb */
            width: 100%;
            position: absolute; /* Position relative to header */
            bottom: 0.5rem; /* Place it at the bottom of the header */
            left: 50%;
            transform: translateX(-50%);
        }

        main {
            padding: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        input[type="text"],
        input[type="number"] {
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        button {
            padding: 0.5rem;
            border: none;
            border-radius: 5px;
            background-color: #28a745;
            color: white;
            cursor: pointer;
            margin-top: 0.5rem;
        }

        button:hover {
            background-color: #218838;
        }

        .button-row {
            display: flex;
            gap: 0.5rem;
            /* Space between buttons */
            margin-top: 1rem;
            justify-content: flex-start;
            /* Align buttons to the right (due to rtl) */
            flex-wrap: wrap;
            /* Allow wrapping for smaller screens */
        }

        .button-row button {
            flex-grow: 1;
            /* Allow buttons to grow and fill space */
            max-width: 150px;
            /* Limit max width for larger screens */
            margin-top: 0;
            /* Override default margin-top from general button style */
        }


        .person-list {
            margin-top: 1rem;
        }

        .person {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 5px;
        }

        .item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.5rem 0;
            border-bottom: 1px dashed #eee;
        }

        .item:last-child {
            border-bottom: none;
        }

        .total {
            font-weight: bold;
            margin-top: 1rem;
        }

        /* Style for individual person's total */
        .person-total {
            font-size: 0.8em;
            font-weight: bold;
            margin-top: 1rem;
            padding-top: 0.5rem;
            border-top: 1px solid #ccc;
            text-align: right;
            padding-right: 0.5rem;
        }

        .result {
            margin-top: 2rem;
            padding: 1rem;
            background-color: white;
            border-radius: 5px;
        }


        /* Toast Message Styles */
        #toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .toast-message {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            margin-bottom: 10px;
            opacity: 1;
            transition: opacity 0.5s ease-out;
            text-align: center;
            min-width: 200px;
        }

        .toast-message.fade-out {
            opacity: 0;
        }

        /* Editable Spans */
        .person-name-display,
        .item-name-display,
        .item-price-display {
            cursor: pointer;
            text-decoration: underline dotted #666;
        }

        .person-name-display:hover,
        .item-name-display:hover,
        .item-price-display:hover {
            color: #007bff;
        }

        /* Specific styles for inputs replacing spans */
        .item input {
            flex-grow: 1;
        }

        /* Responsive styles */
        @media (max-width: 600px) {
            .item {
                flex-direction: column;
                align-items: stretch;
            }

            .item span {
                margin-bottom: 0.2rem;
            }

            .item button {
                width: 100%;
                margin-top: 0.5rem;
            }

            .button-row {
                flex-direction: column;
                align-items: stretch;
            }

            .button-row button {
                max-width: none;
            }
        }

        /* Print styles */
        
		
		  @media print {
            body {
                color: black !important;
            }

            /* Make header visible and style its contents for print */
            header {
                display: block !important; /* Ensure header itself is visible */
                padding-bottom: 1rem !important;
                background-color: transparent !important; /* No background in print */
                color: black !important; /* Ensure text is black */
                text-align: center !important; /* Center content in header */
                position: relative !important; /* Maintain positioning context */
            }

            header h1 {
                display: none !important; /* Hide the main H1 title */
            }

            #clock {
                display: block !important;
                text-align: left !important;
                font-size: 10pt !important;
                margin-bottom: 0.5cm !important;
                color: black !important;
                position: static !important; /* Reset absolute positioning */
                transform: none !important;
                width: auto !important;
            }

            #sokhaneRooz {
                display: block !important; /* Ensure Sokhane Rooz is visible */
                text-align: center !important;
                font-size: 0.9rem !important;
                margin-top: 0.5rem !important;
                margin-bottom: 1rem !important; /* Add bottom margin */
                color: black !important;
                position: static !important;
                transform: none !important;
                width: auto !important;
            }

            footer,
            .button-row,
            button,
            .form-group label:not([for="eventNameInput"]),
            .form-group input:not(#eventNameInput),
            #toast-container,
            #historyPanel,
            /* Hide history panel during print */
            #modalOverlay,
            /* Hide custom modals during print */
            #customModal
            {
                display: none !important;
            }

            /* For editable spans, remove interactive styles, ensure they are visible and black */
            .person-name-display,
            .item-name-display,
            .item-price-display {
                text-decoration: none !important;
                cursor: default !important;
                color: black !important;
                display: inline !important;
            }


            /* Show event name in print */
            #eventNameInput {
                display: block !important;
                border: none !important;
                padding: 0 !important;
                margin-bottom: 0.5cm !important;
                font-size: 14pt !important;
                font-weight: bold !important;
                color: black !important;
                text-align: center !important;
            }

            #eventNameInput::placeholder {
                color: black;
            }

            label[for="eventNameInput"] {
                display: none !important;
            }


            /* Adjust person/item display for print */
            .person {
                background-color: #f0f0f0 !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
                border: 1px solid #ccc;
                margin-bottom: 0.5cm;
            }

            .item {
                border-bottom: 1px dashed #ddd;
            }

            body {
                margin: 0;
                padding: 0;
                font-size: 12pt;
            }

            main {
                padding: 0.5cm;
            }

            /* Ensure the "no items purchased" message is visible in print */
            .person div[id^="itemList-"] p {
                display: block !important;
                margin: 0.5rem 0;
                color: black !important;
            }

            /* Ensure person total is visible and styled correctly in print */
            .person-total {
                display: block !important;
                color: black !important;
            }
        }

        /* History Panel Styles */
        #historyPanel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            width: 90%;
            max-width: 500px;
            max-height: 80%;
            overflow-y: auto;
            display: none;
            /* Hidden by default */
            padding: 1rem;
        }

        #historyPanel h2 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: #28a745;
            text-align: center;
        }

        #historyPanel .history-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #historyPanel .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #eee;
        }

        #historyPanel .history-item:last-child {
            border-bottom: none;
        }

        #historyPanel .history-item div {
            flex-grow: 1;
        }

        #historyPanel .history-item span {
            display: block;
        }

        #historyPanel .history-item .item-date {
            font-size: 0.8em;
            color: #666;
            margin-top: 0.2rem;
        }

        #historyPanel .history-item .item-buttons {
            display: flex;
            gap: 0.5rem;
        }

        #historyPanel .history-item button {
            padding: 0.4rem 0.8rem;
            font-size: 0.9em;
            margin-top: 0;
            /* Reset general button margin-top */
        }

        #historyPanel .history-item button.load-btn {
            background-color: #007bff;
        }

        #historyPanel .history-item button.load-btn:hover {
            background-color: #0056b3;
        }

        #historyPanel .history-item button.delete-btn {
            background-color: #dc3545;
        }

        #historyPanel .history-item button.delete-btn:hover {
            background-color: #c82333;
        }

        #historyPanel .close-btn {
            background-color: #6c757d;
            margin-top: 1rem;
            width: 100%;
        }

        #historyPanel .close-btn:hover {
            background-color: #5a6268;
        }

        #historyPanel p.no-history {
            text-align: center;
            color: #888;
            margin-top: 1rem;
        }

        /* Custom Modal Styles (for alert/confirm) */
        #modalOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        #customModal {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
            display: none;
            /* Hidden by default, controlled by JS along with overlay */
        }

        #customModal h3 {
            margin-top: 0;
            color: #28a745;
            margin-bottom: 1rem;
        }

        #customModal p {
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        #customModal .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        #customModal .modal-buttons button {
            padding: 0.6rem 1.5rem;
            margin-top: 0;
            /* Reset general button margin-top */
            flex-grow: 1;
            /* Allow buttons to grow */
            max-width: 120px;
            /* Limit max width */
        }

        #customModal .modal-buttons button.confirm-btn {
            background-color: #28a745;
        }

        #customModal .modal-buttons button.confirm-btn:hover {
            background-color: #218838;
        }

        #customModal .modal-buttons button.cancel-btn {
            background-color: #6c757d;
        }

        #customModal .modal-buttons button.cancel-btn:hover {
            background-color: #5a6268;
        }

        #customModal .modal-buttons button.alert-ok-btn {
            background-color: #007bff;
        }

        #customModal .modal-buttons button.alert-ok-btn:hover {
            background-color: #0056b3;
        }

        /* New button colors for main actions */
        .save-btn {
            background-color: #ffc107;
            /* Orange */
            color: #343a40;
            /* Darker text for contrast */
        }

        .save-btn:hover {
            background-color: #e0a800;
        }

        .history-toggle-btn {
            background-color: #17a2b8;
            /* Cyan/Info blue */
        }

        .history-toggle-btn:hover {
            background-color: #138496;
        }

        /* Ensure deleteAllData maintains its red color */
        .delete-all-btn {
            background-color: #dc3545;
        }

        .delete-all-btn:hover {
            background-color: #c82333;
        }
		
    </style>
</head>

<body>
    <header>
        <h1>دنگ‌گیری دورهمی</h1>
        <div id="clock"></div>
        <div id="sokhaneRooz">
            <span style="font-weight: bold;">سخن روز:</span> <span id="sokhaneRoozText"></span>
        </div>
    </header>

    <main>
        <div class="form-group">
            <label for="eventNameInput">نام دورهمی:</label>
            <input type="text" id="eventNameInput" placeholder="دنگ دورهمی">
        </div>

        <div class="form-group">
            <label for="personName">نام شخص:</label>
            <input type="text" id="personName" placeholder="نام شخص">
            <button onclick="addPerson()" style="background-color: #23917d; color: white; cursor: pointer;">افزودن شخص</button>
        </div>

        <div class="person-list" id="personList">
            <!-- افراد اینجا اضافه می‌شوند -->
        </div>

        <div class="button-row">
            <button onclick="calculateDebts()" style="background-color: #003366; color: white; cursor: pointer;">محاسبه دنگ</button>
            <button onclick="saveGathering()" class="save-btn">ذخیره دورهمی</button>
            <button onclick="showHistoryPanel()" class="history-toggle-btn">مشاهده تاریخچه</button>
            <button onclick="window.print()" style="background-color: purple; color: white; cursor: pointer;" >چاپ</button>
            <button onclick="deleteAllData()" class="delete-all-btn">حذف همه</button>
        </div>

        <div class="result" id="result">
            <!-- نتایج محاسبات اینجا نمایش داده می‌شوند -->
        </div>
    </main>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- History Panel -->
    <div id="historyPanel">
        <h2>تاریخچه دورهمی‌ها</h2>
        <ul class="history-list" id="historyList">
            <!-- History items will be inserted here -->
        </ul>
        <button onclick="hideHistoryPanel()" class="close-btn">بستن</button>
    </div>

    <!-- Custom Modal for Alert/Confirm -->
    <div id="modalOverlay">
        <div id="customModal">
            <h3 id="modalTitle"></h3>
            <p id="modalMessage"></p>
            <div class="modal-buttons">
                <!-- Buttons will be dynamically added here -->
            </div>
        </div>
    </div>


    <script>
        let people = [];
        const STORAGE_KEY_HISTORY = 'dongGatheringsHistory';

        // آرایه سخنان حکیمانه فارسی
      const persianSayings = [
    "آب از آب تکان نمی‌خوره.",
    "آش نخورده و دهن سوخته.",
    "از کاه کوه ساختن.",
    "از ماست که بر ماست.",
    "باد آورده رو باد می‌بره.",
    "با یه دست نمیشه دو تا هندونه برداشت.",
    "با یه گل بهار نمیشه.",
    "بار کج به منزل نمیرسه.",
    "به در بگو دیوار بشنوه.",
    "پز عالی، جیب خالی.",
    "تا تنور داغه، نون رو بچسبون.",
    "چوب لای چرخ گذاشتن.",
    "خروس بی‌محل.",
    "خود کرده را تدبیر نیست.",
    "دبه درآوردن.",
    "دیوار حاشا بلنده.",
    "رطب خورده، منع رطب کی کند؟",
    "سنگ مفت، گنجشک مفت.",
    "شتر دیدی ندیدی.",
    "کاچی بهتر از هیچی.",
    "بنی آدم اعضای یکدیگرند که در آفرینش ز یک گوهرند. (سعدی)",
    "تو نیکی کن و در دجله انداز که ایزد در بیابانت دهد باز. (سعدی)",
    "گر صبر کنی ز غوره حلوا سازی.",
    "هر که بامش بیش، برفش بیشتر.",
    "کمال همنشین در من اثر کرد وگرنه من همان خاکم که هستم. (سعدی)",
    "آنچه نپاید دلبستگی را نشاید. (سعدی)",
    "از محبت خارها گل می‌شود. (مولوی)",
    "جوانی نوبهار زندگانیست.",
    "قطره قطره جمع گردد وانگهی دریا شود.",
    "دو صد گفته چون نیم کردار نیست.",
    "دست بالای دست بسیار است.",
    "کار نیکو کردن از پر کردن است.",
    "آب از سرچشمه گل آلود است.",
    "خواهی نشوی رسوا، همرنگ جماعت شو.",
    "عاقبت جوینده یابنده بود.",
    "هر سخن جایی و هر نکته مکانی دارد.",
    "چو دانی و پرسی، سزای تو نیست. (فردوسی)",
    "مشت نمونه خروار است.",
    "نابرده رنج گنج میسر نمی‌شود مزد آن گرفت جان برادر که کار کرد. (سعدی)",
    "هر که را جامه پارسا بینی پارسا دان و نیک مرد انگار. (سعدی)",
    "بخت نیکان را گهی بد می‌شود.",
    "هر چه بگندد نمکش می‌زنند وای به روزی که بگندد نمک.",
    "چراغی که به خانه رواست، به مسجد حرام است.",
    "در ناامیدی بسی امید است پایان شب سیه سپید است.",
    "ماهی را هر وقت از آب بگیری تازه است.",
    "سنگی که به مقصد نرسد، باری برمی‌دارد.",
    "آب رفته به جوی باز نمی‌گردد.",
    "از دل برود هر آنکه از دیده برفت.",
    "گربه دستش به گوشت نمی‌رسید، می‌گفت پیف پیف بو می‌دهد.",
    "نان را به نرخ روز خوردن.",
    "گرگ زاده عاقبت گرگ شود گرچه با آدمی بزرگ شود. (سعدی)",
    "آنقدر آب نیست که کوزه بشکند.",
    "ادب از که آموختی؟ از بی‌ادبان.",
    "چاه کن همیشه ته چاه است.",
    "شنونده باید عاقل باشد.",
    "دیوار موش داره، موش گوش داره.",
    "هر چه را خوار شماری خوار شود.",
    "صبر تلخ است ولیکن میوه شیرین دهد.",
    "با دوستان مروت، با دشمنان مدارا. (سعدی)",
    "دوری و دوستی.",
    "از این ستون به آن ستون فرج است.",
    "هر که تنها قاضی رفت، راضی برگشت.",
    "شتر در خواب بیند پنبه دانه.",
    "هر گردی گردو نیست.",
    "باد در قفس نگه داشتن.",
    "از تو حرکت، از خدا برکت.",
    "کار از محکم‌کاری عیب نمی‌کند.",
    "صلاح کار کجا و من خراب کجا. (حافظ)",
    "سرکه نقد، حلوای نسیه.",
    "آب که یکجا ماند، می‌گندد.",
    "تا نباشد چوب تر، فرمان نبرند گاو و خر.",
    "هر کبوتر با کبوتر، باز با باز.",
    "گنج در ویرانه پنهان است.",
    "خواهی که بدانی چه کسی هستی، بنگر که با که همنشینی.",
    "هر چیزی که در جستن آنی، آنی. (مولوی)",
    "هر که بداندیشد، رنجور است.",
    "دیگ به دیگ می‌گوید رویت سیاه.",
    "قسم حضرت عباس، دم خروس باور کنیم؟",
    "هر دم از این باغ بری می‌رسد تازه‌تر از تازه‌تری می‌رسد.",
    "مرغ همسایه غاز است.",
    "سر تا پا گوش بودن.",
    "از کوزه همان برون تراود که در اوست. (باباطاهر)",
    "گر به دولت برسی مست نگردی مردی.",
    "صبر و ظفر هر دو دوستان قدیم‌اند.",
    "هر کسی را بهر کاری ساختند مهر او را در دلش انداختند. (مولوی)",
    "عیب کسان منگر و احسان خویش. (حافظ)",
    "آب دریا را نتوان خشک کرد با سنگ ریزه.",
    "هر که را یک هنر باشد، او را بس.",
    "به دعای گربه سیاه باران نمی‌بارد.",
    "درخت هر چه پربارتر باشد، سر به زیرتر است.",
    "این نیز بگذرد.",
    "باد کاشتن و توفان درو کردن.",
    "شکر نعمت، نعمتت افزون کند.",
    "از گهواره تا گور دانش بجوی.",
    "چشم تنگ دنیا دوست را یا قناعت پر کند یا خاک گور. (سعدی)",
    "سنگ بزرگ علامت نزدن است.",
    "عاقل کند کاری که باز آرد پشیمانی.",
    "دست پنهان بیش از آشکار توانایی دارد.",
    "هرچه پیش آید خوش آید.",
    "گندم از گندم بروید، جو از جو.",
 "دم خروسو باور کنیم یا قسم حضرت عباس رو؟"

];


        function getRandomColor() {
            const h = Math.floor(Math.random() * 360);
            const s = Math.floor(Math.random() * 30) + 30;
            const l = Math.floor(Math.random() * 20) + 70;
            return `hsl(${h}, ${s}%, ${l}%)`;
        }

        // Global toast message handler
        function showToast(message) {
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                document.body.appendChild(toastContainer);
            }

            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.textContent = message;
            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('fade-out');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 1000); // Display for 1 second, then fade out over 0.5 seconds
        }

        // Custom Modal Functions
        let currentOnConfirm = null;
        let currentOnCancel = null;

        /**
         * Displays a custom modal for alert or confirmation.
         * @param {string} message - The message to display in the modal.
         * @param {'alert'|'confirm'} type - The type of modal ('alert' for OK button, 'confirm' for Yes/No buttons).
         * @param {function} [onConfirmCallback=null] - Callback function to execute when 'Yes' or 'OK' is clicked.
         * @param {function} [onCancelCallback=null] - Callback function to execute when 'No' is clicked (only for 'confirm' type).
         * @param {string} [title=""] - Optional title for the modal.
         */
        function showCustomModal(message, type, onConfirmCallback = null, onCancelCallback = null, title = "") {
            const modalOverlay = document.getElementById('modalOverlay');
            const customModal = document.getElementById('customModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalButtons = customModal.querySelector('.modal-buttons');

            // Clear previous content
            modalButtons.innerHTML = '';

            modalTitle.textContent = title || (type === 'confirm' ? 'تایید' : 'اطلاع');
            modalMessage.textContent = message;

            currentOnConfirm = onConfirmCallback;
            currentOnCancel = onCancelCallback;

            if (type === 'confirm') {
                const confirmBtn = document.createElement('button');
                confirmBtn.textContent = 'بله';
                confirmBtn.className = 'confirm-btn';
                confirmBtn.onclick = () => {
                    if (currentOnConfirm) currentOnConfirm();
                    hideCustomModal();
                };

                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'خیر';
                cancelBtn.className = 'cancel-btn';
                cancelBtn.onclick = () => {
                    if (currentOnCancel) currentOnCancel();
                    hideCustomModal();
                };
                modalButtons.appendChild(confirmBtn);
                modalButtons.appendChild(cancelBtn);
            } else if (type === 'alert') {
                const okBtn = document.createElement('button');
                okBtn.textContent = 'باشه';
                okBtn.className = 'alert-ok-btn';
                okBtn.onclick = () => {
                    if (currentOnConfirm) currentOnConfirm(); // Use onConfirm for OK callback
                    hideCustomModal();
                };
                modalButtons.appendChild(okBtn);
            }

            modalOverlay.style.display = 'flex';
            customModal.style.display = 'block';
        }

        function hideCustomModal() {
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('customModal').style.display = 'none';
            currentOnConfirm = null;
            currentOnCancel = null;
        }
        // End Custom Modal Functions

        function addPerson() {
            const personNameInput = document.getElementById('personName');
            let personName = personNameInput.value.trim();

            if (personName === "") {
                const nextPersonNumber = people.length + 1;
                personName = `فرد ${nextPersonNumber}`;
                showToast(`نام وارد نشد. شخص به عنوان "${personName}" اضافه شد.`);
            } else {
                showToast(`شخص "${personName}" اضافه شد.`);
            }

            const person = {
                name: personName,
                items: [],
                backgroundColor: getRandomColor(),
            };
            people.push(person);
            renderPeople();
            personNameInput.value = "";
        }

        // Function to format number for display
        // decimalPlaces: Number of decimal places to show.
        // forResultDisplay: If true, formats with ' as thousands separator and / as decimal separator, and ensures LTR rendering.
        function formatNumber(number, decimalPlaces = 0, forResultDisplay = false) {
            const num = parseFloat(number);
            if (isNaN(num)) return '0';

            // Step 1: Round to specified decimal places and convert to string.
            // This will produce a string with '.' as decimal separator and no thousands separators initially.
            let numStr = num.toFixed(decimalPlaces); // e.g., "12345.678" or "12345"

            // Step 2: Add thousands separators and handle decimal part based on 'forResultDisplay'
            if (forResultDisplay) {
                // Split into integer and fractional parts
                const parts = numStr.split('.');
                let integerPart = parts[0];
                let fractionalPart = parts.length > 1 ? parts[1] : '';

                // Add standard comma thousands separators first (temporarily)
                integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');

                // Combine and then replace standard separators with custom ones
                let finalFormattedStr = integerPart;
                if (fractionalPart) {
                    finalFormattedStr += '.' + fractionalPart;
                }

                // Replace commas with single quotes and dots with slashes
                // And importantly, prepend with LTR mark to ensure correct directionality in RTL context
                return '\u200E' + finalFormattedStr.replace(/,/g, "'").replace(/\./g, "/");

            } else {
                // Original logic for general display (e.g., item prices, person totals)
                const parts = numStr.split('.');
                let integerPart = parts[0];
                let fractionalPart = parts.length > 1 ? parts[1] : '';

                // Add commas as thousands separators
                integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');

                // Combine
                if (fractionalPart) {
                    return `${integerPart}.${fractionalPart}`;
                } else {
                    return integerPart;
                }
            }
        }

        // Function to format price input field dynamically
        function formatPriceInput(input) {
            let value = input.value.replace(/[^0-9]/g, ''); // Remove non-digits
            if (value === "") {
                input.value = "";
                return;
            }
            // Use toLocaleString for input formatting (standard comma/dot)
            input.value = Number(value).toLocaleString('en-US');
        }

        function addItem(personIndex) {
            const person = people[personIndex];
            const itemNameInput = document.getElementById(`itemName-${personIndex}`);
            const itemPriceInput = document.getElementById(`itemPrice-${personIndex}`);

            let itemName = itemNameInput.value.trim();
            const itemPriceStr = itemPriceInput.value.replace(/,/g, '');
            const itemPrice = parseFloat(itemPriceStr);

            // Price validation is still mandatory
            if (isNaN(itemPrice) || itemPrice < 0) {
                showToast("لطفا قیمت معتبر (بیشتر از صفر) را وارد کنید.");
                return;
            }

            // If item name is empty, assign an anonymous name based on the current number of items
            if (itemName === "") {
                const nextItemNumber = person.items.length + 1; // Corrected logic
                itemName = `قلم ${nextItemNumber}`;
                showToast(`نام جنس وارد نشد. جنس به عنوان "${itemName}" اضافه شد.`);
            } else {
                showToast(`جنس "${itemName}" برای ${person.name} اضافه شد.`);
            }

            person.items.push({
                name: itemName,
                price: itemPrice
            });
            renderPeople();
            itemNameInput.value = "";
            itemPriceInput.value = "";
        }

        function removeItem(personIndex, itemIndex) {
            const personName = people[personIndex].name;
            const itemName = people[personIndex].items[itemIndex].name;
            people[personIndex].items.splice(itemIndex, 1);
            renderPeople();
            showToast(`جنس "${itemName}" از ${personName} حذف شد.`);
        }

        function removePerson(personIndex) {
            const personName = people[personIndex].name;
            people.splice(personIndex, 1);
            // Re-render to correctly update person numbering after deletion
            renderPeople();
            showToast(`شخص "${personName}" حذف شد.`);
        }

        function renderPeople() {
            const personList = document.getElementById('personList');
            personList.innerHTML = "";

            people.forEach((person, personIndex) => {
                // Calculate totalSpent for the current person before rendering their section
                person.totalSpent = person.items.reduce((sum, item) => sum + item.price, 0);

                const personDiv = document.createElement('div');
                personDiv.className = 'person';
                personDiv.style.backgroundColor = person.backgroundColor;
                personDiv.innerHTML = `
                    <h2>
                        <span class="person-name-display" onclick="editPersonName(${personIndex})">${personIndex + 1}. ${person.name}</span>
                        <button onclick="removePerson(${personIndex})" style="background-color: #dc3545;">حذف شخص</button>
                    </h2>
                    <div class="form-group">
                        <label for="itemName-${personIndex}">نام جنس:</label>
                        <input type="text" id="itemName-${personIndex}" placeholder="نام جنس (اختیاری)">
                        <label for="itemPrice-${personIndex}">قیمت:</label>
                        <input type="text" id="itemPrice-${personIndex}" placeholder="قیمت" oninput="formatPriceInput(this)">
                        <button onclick="addItem(${personIndex})">افزودن جنس</button>
                    </div>
                    <h3>جنس‌های خریداری شده:</h3>
                    <div id="itemList-${personIndex}">
                        ${renderItems(person, personIndex)}
                    </div>
                    <p class="person-total">مجموع خریدها: ${formatNumber(person.totalSpent)} تومان</p>
                `;
                personList.appendChild(personDiv);
            });
        }

        function renderItems(person, personIndex) {
            if (person.items.length === 0) {
                return "<p>هیچ جنسی خریداری نشده است.</p>";
            }

            let itemsHTML = "";
            person.items.forEach((item, itemIndex) => {
                itemsHTML += `
                    <div class="item">
                        <span>
                            ${itemIndex + 1}.
                            <span class="item-name-display" onclick="editItemDetails(${personIndex}, ${itemIndex}, 'name')">${item.name}</span>
                        </span>
                        <span>
                            <span class="item-price-display" onclick="editItemDetails(${personIndex}, ${itemIndex}, 'price')">${formatNumber(item.price)}</span> تومان
                        </span>
                        <button onclick="removeItem(${personIndex}, ${itemIndex})" style="background-color: #dc3545;">حذف جنس</button>
                    </div>
                `;
            });
            return itemsHTML;
        }

        // Helper function to create editable input fields
        function createEditableInput(parentElement, initialValue, onSaveCallback, isPrice = false) {
            const input = document.createElement('input');
            input.type = 'text';
            // Remove commas from initial value for input field, especially for prices
            input.value = initialValue.toString().replace(/,/g, '');
            input.style.width = '100%';
            input.style.padding = '0.3rem';
            input.style.border = '1px solid #ccc';
            input.style.borderRadius = '3px';
            input.style.boxSizing = 'border-box';

            parentElement.replaceWith(input);

            input.focus();
            input.select(); // Select all text in the input field

            if (isPrice) {
                input.oninput = () => formatPriceInput(input);
            }

            const saveChanges = () => {
                let newValue = input.value.trim();
                let originalValue = initialValue;

                if (isPrice) {
                    newValue = parseFloat(newValue.replace(/,/g, ''));
                    originalValue = parseFloat(originalValue.toString().replace(/,/g, ''));
                    if (isNaN(newValue) || newValue < 0) {
                        showToast("قیمت وارد شده معتبر نیست. مقدار قبلی حفظ شد.");
                        onSaveCallback(originalValue);
                        return;
                    }
                } else if (newValue === "") {
                    showToast("نام نمی‌تواند خالی باشد. مقدار قبلی حفظ شد.");
                    onSaveCallback(originalValue);
                    return;
                }

                onSaveCallback(newValue);
            };

            input.addEventListener('blur', saveChanges);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    saveChanges();
                    input.blur();
                }
            });
        }

        function editPersonName(personIndex) {
            const person = people[personIndex];
            const nameSpan = document.querySelector(`#personList > div:nth-child(${personIndex + 1}) h2 .person-name-display`);

            if (!nameSpan || nameSpan.querySelector('input')) return;

            const currentNameText = nameSpan.textContent;
            const initialName = currentNameText.replace(/^\d+\.\s*/, '').trim();

            createEditableInput(nameSpan, initialName, (newValue) => {
                people[personIndex].name = newValue;
                showToast(`نام به "${newValue}" تغییر یافت.`);
                renderPeople();
            });
        }

        function editItemDetails(personIndex, itemIndex, type) {
            const person = people[personIndex];
            const item = person.items[itemIndex];
            let targetSpan;
            let initialValue;

            if (type === 'name') {
                targetSpan = document.querySelector(`#itemList-${personIndex} > .item:nth-child(${itemIndex + 1}) .item-name-display`);
                initialValue = item.name;
            } else if (type === 'price') {
                targetSpan = document.querySelector(`#itemList-${personIndex} > .item:nth-child(${itemIndex + 1}) .item-price-display`);
                // Pass the raw number for editing, formatNumber is only for display
                initialValue = item.price;
            } else {
                return;
            }

            if (!targetSpan || targetSpan.querySelector('input')) return;

            createEditableInput(targetSpan, initialValue, (newValue) => {
                if (type === 'name') {
                    item.name = newValue;
                } else if (type === 'price') {
                    item.price = newValue;
                }
                showToast(`تغییرات ذخیره شد.`);
                renderPeople();
            }, type === 'price');
        }

        function calculateDebts() {
            if (people.length === 0) {
                showToast("لطفا حداقل یک شخص اضافه کنید تا دنگ محاسبه شود.");
                return;
            }

            let totalExpenses = 0;
            people.forEach(person => {
                person.totalSpent = person.items.reduce((sum, item) => sum + item.price, 0);
                totalExpenses += person.totalSpent;
            });

            const averageExpense = totalExpenses / people.length;

            let debts = [];
            people.forEach(person => {
                const diff = person.totalSpent - averageExpense;
                debts.push({
                    name: person.name,
                    amount: diff
                });
            });

            renderResult(debts, totalExpenses);
            showToast("محاسبه دنگ انجام شد.");
        }

        function renderResult(debts, totalExpenses) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = "<h2>نتایج:</h2>";

            const eventName = document.getElementById('eventNameInput').value.trim();
            if (eventName) {
                resultDiv.innerHTML += `<p class="total">نام دورهمی: ${eventName}</p>`;
            }

            debts.forEach(debt => {
                // Show debt amounts with 3 decimal places, using the result display format
                const formattedAmount = formatNumber(Math.abs(debt.amount), 3, true);
                let message;
                if (debt.amount > 0) {
                    message = `${debt.name} باید ${formattedAmount} تومان از دیگران بگیرد.`;
                } else {
                    message = `${debt.name} باید ${formattedAmount} تومان به دیگران بدهد.`;
                }
                resultDiv.innerHTML += `<p>${message}</p>`;
            });

            resultDiv.innerHTML += `<p class="total">تعداد کل افراد: ${people.length} نفر</p>`;
            // Show total expenses with 0 decimal places, using the result display format
            resultDiv.innerHTML += `<p class="total">کل هزینه پرداخت شده: ${formatNumber(totalExpenses, 0, true)} تومان</p>`;
        }

        function deleteAllData() {
            showCustomModal("آیا از حذف تمام اطلاعات (افراد، اجناس، نتایج و نام دورهمی) مطمئن هستید؟", "confirm", () => {
                people = [];
                document.getElementById('eventNameInput').value = '';
                document.getElementById('personName').value = '';
                renderPeople(); // Clear person list
                document.getElementById('result').innerHTML = ''; // Clear results
                showToast("تمام اطلاعات حذف شد.");
            }, null, "حذف همه اطلاعات"); // Added a title for the modal
        }

        function updateClock() {
            const now = new Date();
            const daysOfWeek = ["یکشنبه", "دوشنبه", "سه‌شنبه", "چهارشنبه", "پنجشنبه", "جمعه", "شنبه"];
            const dayOfWeek = daysOfWeek[now.getDay()];
            const time = now.toLocaleTimeString('fa-IR');
            const date = now.toLocaleDateString('fa-IR');
            document.getElementById('clock').innerText = `${dayOfWeek}، ${date} - ${time}`;
        }

        // --- New function to display a random Persian saying ---
        function displayRandomSaying() {
            const randomIndex = Math.floor(Math.random() * persianSayings.length);
            const selectedSaying = persianSayings[randomIndex];
            document.getElementById('sokhaneRoozText').textContent = selectedSaying;
        }

        // --- New features implementation (Save, History, Custom Modals) ---

        /**
         * Retrieves the history of gatherings from localStorage.
         * @returns {Array} An array of stored gathering objects.
         */
        function getHistory() {
            try {
                const historyJson = localStorage.getItem(STORAGE_KEY_HISTORY);
                return historyJson ? JSON.parse(historyJson) : [];
            } catch (e) {
                console.error("Error reading from localStorage:", e);
                return [];
            }
        }

        /**
         * Saves the current history array to localStorage.
         * @param {Array} history - The array of gathering objects to save.
         */
        function saveHistory(history) {
            try {
                localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(history));
            } catch (e) {
                console.error("Error writing to localStorage:", e);
                showToast("خطا در ذخیره اطلاعات. فضای ذخیره‌سازی پر است یا مرورگر از آن پشتیبانی نمی‌کند.");
            }
        }

        /**
         * Saves the current gathering's data (people and event name) to history.
         */
        function saveGathering() {
            const eventNameInput = document.getElementById('eventNameInput');
            let eventName = eventNameInput.value.trim();
            const timestamp = Date.now();

            if (!eventName) {
                const dateOptions = {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                };
                eventName = `دورهمی ${new Date(timestamp).toLocaleDateString('fa-IR', dateOptions)}`;
            }

            const currentGatheringData = {
                people: JSON.parse(JSON.stringify(people)), // Deep copy to prevent reference issues
                eventName: eventNameInput.value.trim() || `دنگ دورهمی ${new Date(timestamp).toLocaleDateString('fa-IR')}` // Use default for input if empty
            };

            const newGathering = {
                id: timestamp,
                name: eventName,
                timestamp: timestamp,
                data: currentGatheringData
            };

            const history = getHistory();
            history.unshift(newGathering); // Add to the beginning of the list
            saveHistory(history);
            showToast(`دورهمی "${newGathering.name}" ذخیره شد.`);
        }

        /**
         * Loads a selected gathering from history into the current view.
         * @param {number} id - The ID (timestamp) of the gathering to load.
         */
        function loadGathering(id) {
            const history = getHistory();
            const gatheringToLoad = history.find(g => g.id === id);

            if (gatheringToLoad) {
                showCustomModal(
                    `آیا مطمئن هستید که می‌خواهید دورهمی "${gatheringToLoad.name}" را بارگذاری کنید؟\nتمام اطلاعات فعلی پاک خواهد شد.`,
                    "confirm",
                    () => {
                        people = gatheringToLoad.data.people || [];
                        document.getElementById('eventNameInput').value = gatheringToLoad.data.eventName || '';
                        renderPeople();
                        document.getElementById('result').innerHTML = ''; // Clear previous results
                        hideHistoryPanel();
                        showToast(`دورهمی "${gatheringToLoad.name}" بارگذاری شد.`);
                    },
                    null,
                    "بارگذاری دورهمی"
                );
            } else {
                showCustomModal("دورهمی مورد نظر یافت نشد.", "alert", null, null, "خطا");
            }
        }

        /**
         * Deletes a specific gathering from the history.
         * @param {number} id - The ID (timestamp) of the gathering to delete.
         */
        function deleteHistoryItem(id) {
            const history = getHistory();
            const itemToDelete = history.find(g => g.id === id);

            if (itemToDelete) {
                showCustomModal(
                    `آیا مطمئن هستید که می‌خواهید دورهمی "${itemToDelete.name}" را حذف کنید؟`,
                    "confirm",
                    () => {
                        const updatedHistory = history.filter(g => g.id !== id);
                        saveHistory(updatedHistory);
                        showToast(`دورهمی "${itemToDelete.name}" حذف شد.`);
                        showHistoryPanel(); // Changed from renderHistoryPanel() to showHistoryPanel()
                    },
                    null,
                    "حذف دورهمی"
                );
            }
        }

        /**
         * Displays the history panel with all saved gatherings.
         */
        function showHistoryPanel() {
            const historyPanel = document.getElementById('historyPanel');
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = ''; // Clear previous list

            const history = getHistory();

            if (history.length === 0) {
                historyList.innerHTML = '<p class="no-history">هیچ دورهمی ذخیره شده‌ای وجود ندارد.</p>';
            } else {
                history.forEach(gathering => {
                    const listItem = document.createElement('li');
                    listItem.className = 'history-item';

                    const dateOptions = {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    };
                    const formattedDate = new Date(gathering.timestamp).toLocaleDateString('fa-IR', dateOptions);

                    listItem.innerHTML = `
                        <div>
                            <span>${gathering.name}</span>
                            <span class="item-date">${formattedDate}</span>
                        </div>
                        <div class="item-buttons">
                            <button class="load-btn" onclick="loadGathering(${gathering.id})">بارگذاری</button>
                            <button class="delete-btn" onclick="deleteHistoryItem(${gathering.id})">حذف</button>
                        </div>
                    `;
                    historyList.appendChild(listItem);
                });
            }

            historyPanel.style.display = 'block'; // Show the panel
        }

        /**
         * Hides the history panel.
         */
        function hideHistoryPanel() {
            document.getElementById('historyPanel').style.display = 'none';
        }


        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', () => {
            updateClock();
            setInterval(updateClock, 1000);
            renderPeople(); // Ensure people list is rendered on load (it will be empty initially unless loaded from somewhere else)
            displayRandomSaying(); // Call new function to display a random saying
        });
    </script>
</body>

</html>